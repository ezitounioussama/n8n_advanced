services:
  # Main n8n service
  n8n:
    image: n8nio/n8n:latest
    restart: always
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      # Database configuration - using SQLite (default, no external DB needed)
      DB_TYPE: sqlite
      
      # n8n configuration
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: 5678
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      WEBHOOK_URL: ${WEBHOOK_URL:-http://localhost:5678}
      GENERIC_TIMEZONE: ${GENERIC_TIMEZONE:-UTC}

      # Security
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:-}
      N8N_USER_MANAGEMENT_JWT_SECRET: ${N8N_JWT_SECRET:-}

      # Execution settings
      EXECUTIONS_MODE: regular
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE:-false}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD:-}

      # Performance
      N8N_CONCURRENCY: ${N8N_CONCURRENCY:-10}
      N8N_QUEUE_BULL_REDIS_HOST: ${N8N_QUEUE_BULL_REDIS_HOST:-}
      N8N_QUEUE_BULL_REDIS_PORT: ${N8N_QUEUE_BULL_REDIS_PORT:-}

      # Data persistence
      N8N_USER_FOLDER: /home/node/.n8n

    volumes:
      # Persistent storage for workflows, credentials, and executions
      - n8n_data:/home/node/.n8n
      # Optional: Mount custom certificates
      - ./custom-certificates:/opt/custom-certificates:ro

    networks:
      - n8n-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  n8n_data:
    driver: local

networks:
  n8n-network:
    driver: bridge
